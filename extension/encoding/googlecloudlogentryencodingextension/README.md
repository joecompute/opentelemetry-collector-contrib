# Google Cloud LogEntry encoding extension

<!-- status autogenerated section -->
| Status        |           |
| ------------- |-----------|
| Stability     | [alpha]  |
| Distributions | [contrib] |
| Issues        | [![Open issues](https://img.shields.io/github/issues-search/open-telemetry/opentelemetry-collector-contrib?query=is%3Aissue%20is%3Aopen%20label%3Aextension%2Fgooglecloudlogentryencoding%20&label=open&color=orange&logo=opentelemetry)](https://github.com/open-telemetry/opentelemetry-collector-contrib/issues?q=is%3Aopen+is%3Aissue+label%3Aextension%2Fgooglecloudlogentryencoding) [![Closed issues](https://img.shields.io/github/issues-search/open-telemetry/opentelemetry-collector-contrib?query=is%3Aissue%20is%3Aclosed%20label%3Aextension%2Fgooglecloudlogentryencoding%20&label=closed&color=blue&logo=opentelemetry)](https://github.com/open-telemetry/opentelemetry-collector-contrib/issues?q=is%3Aclosed+is%3Aissue+label%3Aextension%2Fgooglecloudlogentryencoding) |
| [Code Owners](https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/CONTRIBUTING.md#becoming-a-code-owner)    | [@constanca-m](https://www.github.com/constanca-m) |
| Emeritus      | [@alexvanboxel](https://www.github.com/alexvanboxel) |

[alpha]: https://github.com/open-telemetry/opentelemetry-collector/blob/main/docs/component-stability.md#alpha
[contrib]: https://github.com/open-telemetry/opentelemetry-collector-releases/tree/main/distributions/otelcol-contrib
<!-- end autogenerated section -->

This extension can be used to unmarshall a [Cloud Logging LogEntry](https://cloud.google.com/logging/docs/reference/v2/rest/v2/LogEntry) message type. The extension expects each log to take up 1 line, and it will decode as many logs as log lines received.

Currently, this extension [can parse the following logs](#supported-log-types) into log record attributes:
- [Cloud audit logs](https://cloud.google.com/logging/docs/reference/audit/auditlog/rest/Shared.Types/AuditLog) (extension [mapping](#cloud-audit-logs))
- [VPC flow logs](https://cloud.google.com/vpc/docs/about-flow-logs-records) (extension [mapping](#vpc-flow-logs))

For all others logs, the payload will be placed in the log record attribute. In this case, the following configuration options are supported:

* `handle_json_payload_as` (Optional): This controls how the json payload of the log entry  is parsed into the body.
  The default `json` parses it as standard JSON, while `text` will the put the payload as a single string.
* `handle_proto_payload_as` (Optional): This controls how the json payload of the log entry  is parsed into the body. 
  The default `json` parses it as standard JSON, while `proto` will use the well known protobuf types used in a
  log entry providing a better type handling, but sacrificing stability. Using `text` will the put the payload as a
  single string.

## Log entry fields mapping

The [log entry](https://cloud.google.com/logging/docs/reference/v2/rest/v2/LogEntry) fields are mapped this way in the encoding:


| Original JSON Field Name                     | OpenTelemetry log field                                                                                                                                                            |
|----------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `receiveTimestamp`                           | Log record field: `observedTimeUnixNano`                                                                                                                                           |
| `timestamp`                                  | Log record field: `timeUnixNano`                                                                                                                                                   |
| `insertId`                                   | Log record attribute: `log.record.uid`                                                                                                                                             |
| `logName`                                    | Parse it and place it in the resource log attributes, if present:<br>1.`gcp.project`<br>2.`gcp.organization`<br>3.`gcp.billint_account`<br>4.`gcp.folder`<br>5.`cloud.resource_id` |
| `severity`                                   | Parse it and place in log record fields:<br>1.`severityNumber`<br>2.`severityText`                                                                                                 |
| `trace`                                      | Log record field: `traceId`                                                                                                                                                        |
| `spanId`                                     | Log record field: `spanId`                                                                                                                                                         |
| `traceSampled`                               | Log record field: `flags`                                                                                                                                                          |
| `labels`                                     | Log record attribute: `gcp.label.<label_key>`                                                                                                                                      |
| `httpRequest.requestMethod`                  | Log record attribute: `http_request.request_method`                                                                                                                                |
| `httpRequest.requestUrl`                     | Log record attribute: `url.full`<br>Parse it, and place it in the log record attributes:<br>1.`url.path`<br>2.`url.query`<br>3.`url.domain`                                        |
| `httpRequest.requestSize`                    | Log record attribute: `http.request.size`                                                                                                                                          |
| `httpRequest.status`                         | Log record attribute: `http.response.status_code`                                                                                                                                  |
| `httpRequest.responseSize`                   | Log record attribute: `http.response.size`                                                                                                                                         |
| `httpRequest.userAgent`                      | Log record attribute: `user_agent.original`                                                                                                                                        |
| `httpRequest.remoteIp`                       | Log record attribute: `client.address`                                                                                                                                             |
| `httpRequest.serverIp`                       | Log record attribute: `server.address`                                                                                                                                             |
| `httpRequest.referer`                        | Log record attribute: `http.request.header.referer`                                                                                                                                |
| `httpRequest.latency`                        | Log record attribute: `http.request.server.duration`                                                                                                                               |
| `httpRequest.cacheLookup`                    | Log record attribute: `gcp.cache.lookup`                                                                                                                                           |
| `httpRequest.cacheHit`                       | Log record attribute: `gcp.cache.hit`                                                                                                                                              |
| `httpRequest.cacheValidatedWithOriginServer` | Log record attribute: `gcp.cache.validated_with_origin_server`                                                                                                                     |
| `httpRequest.cacheFillBytes`                 | Log record attribute: `gcp.cache.fill_bytes`                                                                                                                                       |
| `httpRequest.protocol`                       | Parse it, and place it in log record attribute:<br>1.`network.protocol.name`.<br>2.`network.protocol.version`                                                                      |
| `resource.type`                              | Resource log attribute: `gcp.resource_type`                                                                                                                                        |
| `resource.labels`                            | Resource log attribute: `gcp.label.<label_key>`                                                                                                                                    |
| `operation.id`                               | Log record attribute: `gcp.operation.id`                                                                                                                                           |
| `operation.producer`                         | Log record attribute: `gcp.operation.producer`                                                                                                                                     |
| `operation.first`                            | Log record attribute: `gcp.operation.first`                                                                                                                                        |
| `operation.last`                             | Log record attribute: `gcp.operation.last`                                                                                                                                         |
| `sourceLocation.file`                        | Log record attribute: `code.file.path`                                                                                                                                             |
| `sourceLocation.line`                        | Log record attribute: `code.line.number`                                                                                                                                           |
| `sourceLocation.function`                    | Log record attribute: `code.function.name`                                                                                                                                         |
| `protoPayload`                               | Placed on the record body as is, unless log type is supported                                                                                                                      |
| `textPayload`                                | Placed on the record body as is, unless log type is supported                                                                                                                      |
| `jsonPayload`                                | Placed on the record body as is, unless log type is supported                                                                                                                      |
| `split.uid`                                  | Log record attribute: `gcp.split.uid`                                                                                                                                              |                                                                         |
| `split.index`                                | Log record attribute: `gcp.split.index`                                                                                                                                            |                                                                         |
| `split.totalSplits`                          | Log record attribute: `gcp.split.total`                                                                                                                                            |                                                                         |
| `errorGroups[].id`                           | Log record attribute: `gcp.error_groups` list<br>Each element has attribute `id`                                                                                                   |                                                                         |
| `apphub.application.container`               | Log record attribute: `gcp.apphub.application.container`                                                                                                                           |                                                                         |
| `apphub.application.location`                | Log record attribute: `gcp.apphub.application.location`                                                                                                                            |                                                                         |
| `apphub.application.id`                      | Log record attribute: `gcp.apphub.application.id`                                                                                                                                  |                                                                         |
| `apphub.service.id`                          | Log record attribute: `gcp.apphub.service.id`                                                                                                                                      |                                                                         |
| `apphub.service.environmentType`             | Log record attribute: `gcp.apphub.service.environment_type`                                                                                                                        |                                                                         |
| `apphub.service.criticalityType`             | Log record attribute: `gcp.apphub.service.criticality_type`                                                                                                                        |                                                                         |
| `apphub.workload.id`                         | Log record attribute: `gcp.apphub.workload.id`                                                                                                                                     |                                                                         |
| `apphub.workload.environmentType`            | Log record attribute: `gcp.apphub.workload.environment_type`                                                                                                                       |                                                                         |
| `apphub.workload.criticalityType`            | Log record attribute: `gcp.apphub.workload.criticality_type`                                                                                                                       |                                                                         |
| `apphubDestination.application.container`    | Log record attribute: `gcp.apphub_destination.application.container`                                                                                                               |                                                                         |
| `apphubDestination.application.location`     | Log record attribute: `gcp.apphub_destination.application.location`                                                                                                                |                                                                         |
| `apphubDestination.application.id`           | Log record attribute: `gcp.apphub_destination.application.id`                                                                                                                      |                                                                         |
| `apphubDestination.service.id`               | Log record attribute: `gcp.apphub_destination.service.id`                                                                                                                          |                                                                         |
| `apphubDestination.service.environmentType`  | Log record attribute: `gcp.apphub_destination.service.environment_type`                                                                                                            |                                                                         |
| `apphubDestination.service.criticalityType`  | Log record attribute: `gcp.apphub_destination.service.criticality_type`                                                                                                            |                                                                         |
| `apphubDestination.workload.id`              | Log record attribute: `gcp.apphub_destination.workload.id`                                                                                                                         |                                                                         |
| `apphubDestination.workload.environmentType` | Log record attribute: `gcp.apphub_destination.workload.environment_type`                                                                                                           |                                                                         |
| `apphubDestination.workload.criticalityType` | Log record attribute: `gcp.apphub_destination.workload.criticality_type`                                                                                                           |                                                                         |

#### Severity Mapping

The severity is mapped from [Google Cloud Log Severity](https://cloud.google.com/logging/docs/reference/v2/rest/v2/LogEntry#LogSeverity) like this:

| CloudLog         | Severity Number  | CloudLog Description                                                                   |
|------------------|------------------|----------------------------------------------------------------------------------------|
| `DEFAULT`(0)     | `UNSPECIFIED`(0) | The log entry has no assigned severity level.                                          |
| `DEBUG`(100)     | `DEBUG`(5)       | Debug or trace information.                                                            |
| `INFO`(200)      | `INFO`(9)        | Routine information, such as ongoing status or performance.                            |
| `NOTICE`(300)    | `INFO2`(10)      | Normal but significant events, such as start up, shut down, or a configuration change. |
| `WARNING`(400)   | `WARN`(13)       | Warning events might cause problems.                                                   |
| `ERROR`(500)     | `ERROR`(17)      | Error events are likely to cause problems.                                             |
| `CRITICAL`(600)  | `FATAL`(21)      | Critical events cause more severe problems or outages.                                 |
| `ALERT`(700)     | `FATAL2`(22)     | A person must take an action immediately.                                              |
| `EMERGENCY`(800) | `FATAL4`(24)     | One or more systems are unusable.                                                      |

## Supported log types

Currently, these are the log types that are specifically parsed into log record attributes.

### Cloud Audit Logs

See the struct of the Cloud Audit Log payload in [AuditLog](https://cloud.google.com/logging/docs/reference/audit/auditlog/rest/Shared.Types/AuditLog). The fields are mapped this way in the extension:


| Original field                                                             | Log record attribute                                                |
|----------------------------------------------------------------------------|---------------------------------------------------------------------|
| `serviceName`                                                              | `gcp.audit.service.name`                                            |
| `methodName`                                                               | `gcp.audit.method.name`                                             |
| `resourceName`                                                             | `gcp.audit.resource.name`                                           |
| `resourceLocation.currentLocations`                                        | `gcp.audit.resource.location.current`                               |
| `resourceLocation.originalLocations`                                       | `gcp.audit.resource.location.original`                              |
| `resourceOriginalState`                                                    | _Currently not supported_                                           |
| `numResponseItems`                                                         | `gcp.audit.response.items`                                          |
| `status.code`                                                              | `rpc.jsonrpc.error_code`                                            |
| `status.message`                                                           | `rpc.jsonrpc.error_message`                                         |
| `status.details`                                                           | _Currently not supported_                                           |
| `authenticationInfo.principalEmail`                                        | `user.email`                                                        |
| `authenticationInfo.authoritySelector`                                     | `gcp.audit.authentication.authority_selector`                       |
| `authenticationInfo.thirdPartyPrincipal`                                   | _Currently not supported_                                           |
| `authenticationInfo.serviceAccountKeyName`                                 | `gcp.audit.authentication.service_account.key.name`                 |
| `authenticationInfo.serviceAccountDelegationInfo`                          | _Currently not supported_                                           |
| `authenticationInfo.principalSubject`                                      | `user.id`                                                           |
| `authorizationInfo[*].resource`                                            | Item entry `resource` in map `gcp.audit.authorization`              |
| `authorizationInfo[*].permission`                                          | Item entry `permission` in map `gcp.audit.authorization`            |
| `authorizationInfo[*].granted`                                             | Item entry `granted` in map `gcp.audit.authorization``              |
| `authorizationInfo.resourceAttributes`                                     | _Currently not supported_                                           |
| `policyViolationInfo.orgPolicyViolationInfo.payload`                       | _Currently not supported_                                           |
| `policyViolationInfo.orgPolicyViolationInfo.resourceType`                  | `gcp.audit.policy_violation.resource.type`                          |
| `policyViolationInfo.orgPolicyViolationInfo.resourceTags`                  | `gcp.audit.policy_violation.resource.tags`                          |
| `policyViolationInfo.orgPolicyViolationInfo.violationInfo[*].constraint`   | Item entry `constraint` in map `gcp.audit.policy_violation.info`    |
| `policyViolationInfo.orgPolicyViolationInfo.violationInfo[*].errorMessage` | Item entry `error_message` in map `gcp.audit.policy_violation.info` |
| `policyViolationInfo.orgPolicyViolationInfo.violationInfo[*].checkedValue` | Item entry `checked_value` in map `gcp.audit.policy_violation.info` |
| `policyViolationInfo.orgPolicyViolationInfo.violationInfo[*].policyType`   | Item entry `policy_type` in map `gcp.audit.policy_violation.info`   |
| `requestMetadata.callerIp`                                                 | `client.address`                                                    |
| `requestMetadata.callerSuppliedUserAgent`                                  | `user_agent.original`                                               |
| `requestMetadata.callerNetwork`                                            | `gcp.audit.request.caller.network`                                  |
| `requestMetadata.requestAttributes.id`                                     | `http.request.id`                                                   |
| `requestMetadata.requestAttributes.method`                                 | `http.request.method`                                               |
| `requestMetadata.requestAttributes.headers`                                | `http.request.header.<header name>`                                 |
| `requestMetadata.requestAttributes.path`                                   | `url.path`                                                          |
| `requestMetadata.requestAttributes.host`                                   | `http.request.header.host`                                          |
| `requestMetadata.requestAttributes.scheme`                                 | `url.scheme`                                                        |
| `requestMetadata.requestAttributes.query`                                  | `url.query`                                                         |
| `requestMetadata.requestAttributes.time`                                   | `gcp.audit.request.time`                                            |
| `requestMetadata.requestAttributes.size`                                   | `http.request.size`                                                 |
| `requestMetadata.requestAttributes.protocol`                               | `network.protocol.name`                                             |
| `requestMetadata.requestAttributes.reason`                                 | `gcp.audit.request.reason`                                          |
| `requestMetadata.requestAttributes.auth.principal`                         | `gcp.audit.request.auth.principal`                                  |
| `requestMetadata.requestAttributes.auth.audiences`                         | `gcp.audit.request.auth.audiences`                                  |
| `requestMetadata.requestAttributes.auth.presenter`                         | `gcp.audit.request.auth.presenter`                                  |
| `requestMetadata.requestAttributes.auth.accessLevels`                      | `gcp.audit.request.auth.access_levels`                              |
| `requestMetadata.requestAttributes.auth.claims`                            | _Currently not supported_                                           |
| `requestMetadata.destinationAttributes.ip`                                 | `server.address`                                                    |
| `requestMetadata.destinationAttributes.port`                               | `server.port`                                                       |
| `requestMetadata.destinationAttributes.labels`                             | `gcp.audit.destination.label.<label_key>`                           |
| `requestMetadata.destinationAttributes.principal`                          | `gcp.audit.destination.principal`                                   |
| `requestMetadata.destinationAttributes.regionCode`                         | `gcp.audit.destination.region_code`                                 |
| `request`                                                                  | _Currently not supported_                                           |
| `response`                                                                 | _Currently not supported_                                           |
| `metadata`                                                                 | _Currently not supported_                                           |
| `serviceData`                                                              | [GCP Deprecated field]<br>_Currently not supported_                 |

### VPC flow logs

[VPC flow logs](https://cloud.google.com/vpc/docs/about-flow-logs-records) are mapped this way in the resulting OpenTelemetry log:

| Flow log field | Attribute in OpenTelemetry log |
|---|---|
| `connection.protocol` | `network.protocol.name` |
| `connection.src_ip` | `source.address` |
| `connection.dest_ip` | `destination.address` |
| `connection.src_port` | `source.port` |
| `connection.dest_port` | `destination.port` |
| `reporter` | `gcp.vpc.flow.reporter` |
| `rtt_msec` | `network.rtt` |
| `round_trip_time.median_msec` | `gcp.vpc.flow.rtt.median` |
| `bytes_sent` | `gcp.vpc.flow.bytes_sent` |
| `packets_sent` | `gcp.vpc.flow.packets_sent` |
| `start_time` | `gcp.vpc.flow.start_time` |
| `end_time` | Log timestamp |
| `src_gateway.project_id` | `gcp.vpc.src.gateway.project.id` |
| `src_gateway.location` | `gcp.vpc.src.gateway.region` |
| `src_gateway.name` | `gcp.vpc.src.gateway.name` |
| `src_gateway.type` | `gcp.vpc.src.gateway.type` |
| `src_gateway.vpc.project_id` | `gcp.vpc.src.gateway.vpc.project.id` |
| `src_gateway.vpc.subnetwork_name` | `gcp.vpc.src.gateway.vpc.subnet.name` |
| `src_gateway.vpc.subnetwork_region` | `gcp.vpc.src.gateway.vpc.subnet.region` |
| `src_gateway.vpc.vpc_name` | `gcp.vpc.src.gateway.vpc.name` |
| `src_gateway.interconnect_name` | `gcp.vpc.src.gateway.interconnect.name` |
| `src_gateway.interconnect_project_number` | `gcp.vpc.src.gateway.interconnect.project.number` |
| `dest_gateway.project_id` | `gcp.vpc.dest.gateway.project.id` |
| `dest_gateway.location` | `gcp.vpc.dest.gateway.region` |
| `dest_gateway.name` | `gcp.vpc.dest.gateway.name` |
| `dest_gateway.type` | `gcp.vpc.dest.gateway.type` |
| `dest_gateway.vpc.project_id` | `gcp.vpc.dest.gateway.vpc.project.id` |
| `dest_gateway.vpc.subnetwork_name` | `gcp.vpc.dest.gateway.vpc.subnet.name` |
| `dest_gateway.vpc.subnetwork_region` | `gcp.vpc.dest.gateway.vpc.subnet.region` |
| `dest_gateway.vpc.vpc_name` | `gcp.vpc.dest.gateway.vpc.name` |
| `dest_gateway.interconnect_name` | `gcp.vpc.dest.gateway.interconnect.name` |
| `dest_gateway.interconnect_project_number` | `gcp.vpc.dest.gateway.interconnect.project.number` |
| `src_gke_details.cluster.cluster_location` | `gcp.vpc.src.gke.cluster.location` |
| `src_gke_details.cluster.cluster_name` | `gcp.vpc.src.gke.cluster.name` |
| `src_gke_details.pod.pod_name` | `gcp.vpc.src.gke.pod.name` |
| `src_gke_details.pod.pod_namespace` | `gcp.vpc.src.gke.pod.namespace` |
| `src_gke_details.pod.pod_workload.workload_name` | `gcp.vpc.src.gke.pod.workload.name` |
| `src_gke_details.pod.pod_workload.workload_type` | `gcp.vpc.src.gke.pod.workload.type` |
| `src_gke_details.service.service_name` | `gcp.vpc.src.gke.service.name` |
| `src_gke_details.service.service_namespace` | `gcp.vpc.src.gke.service.namespace` |
| `dest_gke_details.cluster.cluster_location` | `gcp.vpc.dest.gke.cluster.location` |
| `dest_gke_details.cluster.cluster_name` | `gcp.vpc.dest.gke.cluster.name` |
| `dest_gke_details.pod.pod_name` | `gcp.vpc.dest.gke.pod.name` |
| `dest_gke_details.pod.pod_namespace` | `gcp.vpc.dest.gke.pod.namespace` |
| `dest_gke_details.pod.pod_workload.workload_name` | `gcp.vpc.dest.gke.pod.workload.name` |
| `dest_gke_details.pod.pod_workload.workload_type` | `gcp.vpc.dest.gke.pod.workload.type` |
| `dest_gke_details.service.service_name` | `gcp.vpc.dest.gke.service.name` |
| `dest_gke_details.service.service_namespace` | `gcp.vpc.dest.gke.service.namespace` |
| `src_google_service.type` | `gcp.vpc.src.google.service.type` |
| `src_google_service.service_name` | `gcp.vpc.src.google.service.name` |
| `src_google_service.connectivity` | `gcp.vpc.src.google.service.connectivity` |
| `src_google_service.private_domain` | `gcp.vpc.src.google.service.domain.private` |
| `dest_google_service.type` | `gcp.vpc.dest.google.service.type` |
| `dest_google_service.service_name` | `gcp.vpc.dest.google.service.name` |
| `dest_google_service.connectivity` | `gcp.vpc.dest.google.service.connectivity` |
| `dest_google_service.private_domain` | `gcp.vpc.dest.google.service.domain.private` |
| `src_instance.project_id` | `gcp.vpc.src.instance.project.id` |
| `src_instance.region` | `gcp.vpc.src.instance.vm.region` |
| `src_instance.vm_name` | `gcp.vpc.src.instance.vm.name` |
| `src_instance.zone` | `gcp.vpc.src.instance.vm.zone` |
| `src_instance.managed_instance_group.name` | `gcp.vpc.src.instance.managedinstancegroup.name` |
| `src_instance.managed_instance_group.region` | `gcp.vpc.src.instance.managedinstancegroup.region` |
| `src_instance.managed_instance_group.zone` | `gcp.vpc.src.instance.managedinstancegroup.zone` |
| `dest_instance.project_id` | `gcp.vpc.dest.instance.project.id` |
| `dest_instance.region` | `gcp.vpc.dest.instance.vm.region` |
| `dest_instance.vm_name` | `gcp.vpc.dest.instance.vm.name` |
| `dest_instance.zone` | `gcp.vpc.dest.instance.vm.zone` |
| `dest_instance.managed_instance_group.name` | `gcp.vpc.dest.instance.managedinstancegroup.name` |
| `dest_instance.managed_instance_group.region` | `gcp.vpc.dest.instance.managedinstancegroup.region` |
| `dest_instance.managed_instance_group.zone` | `gcp.vpc.dest.instance.managedinstancegroup.zone` |
